## container for building stork agent ##
FROM ubuntu:18.04 AS builder
WORKDIR /agent
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends wget xz-utils rake git openjdk-11-jre-headless gcc g++ unzip

# copy base stuff to prepare environment for building
COPY backend/go.mod /agent/backend/go.mod
COPY backend/go.sum /agent/backend/go.sum
COPY backend/version.go /agent/backend/version.go
COPY Rakefile /agent/
RUN rake prepare_env

# copy agent related stuff for building agent part
COPY backend /agent/backend
RUN rake -t build_agent

## container for running stork agent ##
FROM ubuntu:18.04
WORKDIR /agent
# Install essentials and BIND9.
RUN apt-get update && apt-get install -y --no-install-recommends sudo curl ca-certificates gnupg apt-transport-https supervisor bind9 wget prometheus-node-exporter
# Install BIND9 exporter for Prometheus.
RUN wget https://github.com/prometheus-community/bind_exporter/releases/download/v0.3.0/bind_exporter-0.3.0.linux-amd64.tar.gz && \
        tar -zxvf bind_exporter-0.3.0.linux-amd64.tar.gz && \
        mv bind_exporter-0.3.0.linux-amd64/bind_exporter /usr/bin
# Install Stork agent.
COPY --from=builder /agent/backend/cmd/stork-agent/stork-agent /agent/
# Copy configuration files.
COPY docker/supervisor-agent-bind9.conf /etc/supervisor.conf
COPY docker/named.conf /etc/bind/
RUN chown root:bind /etc/bind/rndc.key
RUN chmod 640 /etc/bind/rndc.key
# Start supervisor.
CMD ["supervisord", "-c", "/etc/supervisor.conf"]
