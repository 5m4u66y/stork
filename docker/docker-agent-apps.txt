FROM ubuntu:18.04
WORKDIR /agent
# Install essentials.
RUN apt-get update && apt-get install -y --no-install-recommends sudo curl ca-certificates gnupg apt-transport-https supervisor
RUN curl -1sLf 'https://dl.cloudsmith.io/public/isc/kea-1-7/cfg/setup/bash.deb.sh' | bash
# Install Bind9.
RUN apt-get install -y --no-install-recommends bind9
# Install kea.
RUN apt-get update && apt-get install -y --no-install-recommends isc-kea-dhcp4-server isc-kea-ctrl-agent && mkdir -p /var/run/kea/
RUN perl -pi -e 's/8080/8000/g' /etc/kea/kea-ctrl-agent.conf && perl -pi -e 's/127\.0\.0\.1/0\.0\.0\.0/g' /etc/kea/kea-ctrl-agent.conf
# Install Stork agent.
COPY backend/cmd/stork-agent/stork-agent /agent/
# Copy configuration files.
COPY docker/supervisor-agent-apps.conf /etc/supervisor.conf
COPY docker/kea-dhcp4.conf /etc/kea/
COPY docker/named.conf /etc/bind/
RUN chown root:bind /etc/bind/rndc.key
RUN chmod 640 /etc/bind/rndc.key
# Start supervisor.
CMD ["supervisord", "-c", "/etc/supervisor.conf"]
