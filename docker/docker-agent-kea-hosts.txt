## container for building stork agent ##
FROM ubuntu:18.04 AS builder
WORKDIR /agent
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends wget xz-utils rake git openjdk-11-jre-headless gcc g++ unzip

# copy base stuff to prepare environment for building
COPY backend/go.mod /agent/backend/go.mod
COPY backend/go.sum /agent/backend/go.sum
COPY backend/version.go /agent/backend/version.go
COPY Rakefile /agent/
RUN rake prepare_env

# copy agent related stuff for building agent part
COPY backend /agent/backend
RUN rake -t build_agent

## container for running stork agent ##
FROM ubuntu:18.04
WORKDIR /agent
# Install essentials.
RUN apt-get update && apt-get install -y --no-install-recommends sudo curl ca-certificates gnupg apt-transport-https supervisor prometheus-node-exporter mysql-client
# Install Kea.
ARG CS_REPO_ACCESS_TOKEN
RUN curl -1sLf "https://dl.cloudsmith.io/${CS_REPO_ACCESS_TOKEN}/isc/kea-1-7-prv/cfg/setup/bash.deb.sh" | bash
RUN apt-get update && apt-get install -y --no-install-recommends \
        isc-kea-dhcp4-server=1.7.3-isc0009420191217090201 \
        isc-kea-ctrl-agent=1.7.3-isc0009420191217090201 \
        isc-kea-admin=1.7.3-isc0009420191217090201 \
        isc-kea-premium-host-cmds=1.7.3-isc0009420191217090201 \
        isc-kea-common=1.7.3-isc0009420191217090201 \
        && mkdir -p /var/run/kea/
# Tell CA to listen on all interfaces.
RUN perl -pi -e 's/127\.0\.0\.1/0\.0\.0\.0/g' /etc/kea/kea-ctrl-agent.conf
# Install Stork agent.
COPY --from=builder /agent/backend/cmd/stork-agent/stork-agent /agent/
# Copy configuration files.
COPY docker/supervisor-agent-kea-hosts.conf /etc/supervisor.conf
COPY docker/kea-dhcp4-hosts.conf /etc/kea/kea-dhcp4.conf
COPY docker/kea-hosts-db-init.sh /agent
# Start supervisor.
CMD sleep 15 && /agent/kea-hosts-db-init.sh && supervisord -c /etc/supervisor.conf
