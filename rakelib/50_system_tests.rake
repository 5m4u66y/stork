# System tests
# Run the system tests in docker-compose

#############
### Files ###
#############

system_tests_dir = "tests/system"
kea_many_subnets_dir = "tests/system/config/kea-many-subnets"
directory kea_many_subnets_dir
kea_many_subnets_config_file = File.join(kea_many_subnets_dir, "kea-dhcp4.conf")
file kea_many_subnets_config_file => [kea_many_subnets_dir] do
    sh "python3", "docker/tools/gen-kea-config.py", "7000", "-o",
       kea_many_subnets_config_file
end
CLEAN.append kea_many_subnets_dir

#########################
### System test tasks ###
#########################

desc 'Run system tests
    TEST - Name of the test to run - optional'
task :system_tests => [PYTEST, kea_many_subnets_config_file] do
    opts = []
    if !ENV["TEST"].nil?
        opts.append "-k", ENV["TEST"]
    end
    Dir.chdir(system_tests_dir) do
        sh PYTEST, "-s", *opts
    end
end

desc 'Build the containers used in the system tests'
task :build_system_tests_containers do
    Rake::Task["run_system_tests_compose"].invoke("build")
end

desc 'Run system tests docker-compose'
task :run_system_tests_compose do |t, args|
    ENV["COMPOSE_DOCKER_CLI_BUILD"] = "1"
    ENV["DOCKER_BUILDKIT"] = "1"

    sh "docker-compose",
        "-f", File.expand_path(File.join(system_tests_dir, "docker-compose.yaml")),
        "--project-directory", File.expand_path("."),
        "--project-name", "stork_tests",
        *args
end


desc 'Recreate autogenerated configs'
task :regenerate_configs do
    FileUtils.rm_rf(kea_many_subnets_config_file)
    Rake::FileTask[kea_many_subnets_config_file].invoke()
end
