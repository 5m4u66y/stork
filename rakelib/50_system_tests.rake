# System tests
# Run the system tests in docker-compose

#############
### Files ###
#############

system_tests_dir = "tests/system"
kea_many_subnets_dir = "tests/system/config/kea-many-subnets"
directory kea_many_subnets_dir
kea_many_subnets_config_file = File.join(kea_many_subnets_dir, "kea-dhcp4.conf")
file kea_many_subnets_config_file => [kea_many_subnets_dir] do
    sh "python3", "docker/tools/gen-kea-config.py", "7000", "-o",
       kea_many_subnets_config_file
end
CLEAN.append kea_many_subnets_dir

#########################
### System test tasks ###
#########################

desc 'Run system tests
    TEST - Name of the test to run - optional'
task :system_tests => [PYTEST, kea_many_subnets_config_file] do
    opts = []
    if !ENV["TEST"].nil?
        opts.append "-k", ENV["TEST"]
    end
    Dir.chdir(system_tests_dir) do
        sh PYTEST, "-s", *opts
    end
end

desc 'Recreate autogenerated configs'
task :regenerate_configs do
    FileUtils.rm_rf(kea_many_subnets_config_file)
    Rake::FileTask[kea_many_subnets_config_file].invoke()
end